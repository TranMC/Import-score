name: Build vÃ  Release

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'CHANGELOG.md'
      - 'version.txt'
      - 'version.json'
    tags:
      - 'v*'
  workflow_dispatch:

env:
  PYTHONIOENCODING: utf-8
  PYTHONUTF8: 1
  PIP_NO_CACHE_DIR: 1
  PYTHONDONTWRITEBYTECODE: 1

jobs:
  build:
    runs-on: windows-latest
    outputs:
      version: ${{ env.VERSION }}
      build_date: ${{ env.BUILD_DATE }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: 3.11
        architecture: 'x64'
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install openpyxl>=3.1.0
        pip install pyinstaller==5.13.2
      shell: pwsh
    
    - name: Check for errors in script
      run: |
        python -m py_compile import_score.py write_log.py build_optimized.py
        if ($LASTEXITCODE -ne 0) {
          echo "Compilation check failed"
          exit 1
        }
    
    - name: Setup environment for PyInstaller
      run: |
        # XÃ¡c minh mÃ´i trÆ°á»ng
        Write-Host "Current working directory: $(Get-Location)"
        Write-Host "Python path: $(Get-Command python | Select-Object -ExpandProperty Source)"
        [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
        Write-Host "Set console encoding to UTF-8"
        # Kiá»ƒm tra mÃ´i trÆ°á»ng Python
        python -c "import sys; print(f'Python version: {sys.version}')"
        python -c "import sys; print(f'Python executable: {sys.executable}')"
        python -c "import sys; print(f'Python encoding: {sys.getdefaultencoding()}')"
        python -c "import PyInstaller; print(f'PyInstaller version: {PyInstaller.__version__}')"
      shell: pwsh
    
    - name: Generate version and changelog
      shell: pwsh
      run: |
        [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
        $env:PYTHONIOENCODING = "utf-8"
        python write_log.py
        Get-Content -Encoding UTF8 version.txt
    
    - name: Read version
      id: version
      run: |
        $VERSION = Get-Content version.txt
        echo "VERSION=$VERSION" >> $env:GITHUB_ENV
      shell: pwsh
    
    - name: Update build date
      run: |
        python update_build_date.py
      shell: pwsh
    
    - name: Build executable
      run: |
        python build_optimized.py
      shell: pwsh
    
    - name: Verify build artifact
      run: |
        # Kiá»ƒm tra file Ä‘Ã£ Ä‘Æ°á»£c build Ä‘Ãºng chÆ°a
        $version = Get-Content -Path version.txt -Raw
        $exePath = "dist\Student Score Import v$($version.Trim()).exe"
        
        if (Test-Path $exePath) {
          $fileSize = (Get-Item $exePath).Length / 1MB
          Write-Host "âœ“ Build successful: $exePath ($([math]::Round($fileSize, 2)) MB)"
        } else {
          Write-Host "âŒ Build failed: $exePath not found"
          exit 1
        }
      shell: pwsh
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: dist-files
        path: |
          dist/
          version.txt
          CHANGELOG.md
          version.json
        retention-days: 7
    
  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      VERSION: ${{ needs.build.outputs.version }}
      BUILD_DATE: ${{ needs.build.outputs.build_date }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download build artifact
      uses: actions/download-artifact@v4
      with:
        name: dist-files
        path: ./artifacts
    
    - name: List downloaded artifacts
      run: |
        find ./artifacts -type f -name "*.exe" | sort
        echo "Found files:"
        ls -la ./artifacts/
        VERSION=$(cat ./artifacts/version.txt)
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "Found version: $VERSION"
        
        # Äá»c build_date tá»« version.json
        if [ -f "./artifacts/version.json" ]; then
          BUILD_DATE=$(cat ./artifacts/version.json | grep -o '"build_date": "[^"]*"' | cut -d'"' -f4)
          echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
          echo "Found build date: $BUILD_DATE"
        else
          echo "Warning: version.json not found in artifacts"
        fi
      shell: bash
    
    - name: Prepare release files
      run: |
        mkdir -p release_files
        find ./artifacts/dist -type f -name "Student Score Import v$VERSION.exe" -exec cp {} ./release_files/ \;
        ls -la ./release_files/
      shell: bash
        
    - name: Create release description
      run: |
        echo "# ğŸ“ Thay Ä‘á»•i trong phiÃªn báº£n nÃ y:" > release_description.md
        echo "" >> release_description.md
        cat ./artifacts/CHANGELOG.md | sed -n -e "/## Version $VERSION/,/^---/p" | grep -v "^---" >> release_description.md
        echo -e "\n## âš™ï¸ ThÃ´ng tin build" >> release_description.md
        echo "- **PhiÃªn báº£n:** v$VERSION" >> release_description.md
        echo "- **NgÃ y phÃ¡t hÃ nh:** $BUILD_DATE" >> release_description.md
        echo "- **TÃªn mÃ£:** $(cat ./artifacts/version.json | grep -o '"code_name": "[^"]*"' | cut -d'"' -f4)" >> release_description.md
        
        echo -e "\n## ğŸ” TÃ­nh nÄƒng chÃ­nh" >> release_description.md
        echo "- âœ… Nháº­p vÃ  quáº£n lÃ½ Ä‘iá»ƒm há»c sinh" >> release_description.md
        echo "- âœ… Tá»± Ä‘á»™ng tÃ­nh toÃ¡n Ä‘iá»ƒm tá»« sá»‘ cÃ¢u Ä‘Ãºng" >> release_description.md
        echo "- âœ… Xuáº¥t bÃ¡o cÃ¡o thá»‘ng kÃª dáº¡ng PDF" >> release_description.md
        echo "- âœ… Biá»ƒu Ä‘á»“ phÃ¢n phá»‘i Ä‘iá»ƒm trá»±c quan" >> release_description.md
        echo "- âœ… Giao diá»‡n thÃ¢n thiá»‡n vÃ  dá»… sá»­ dá»¥ng" >> release_description.md
        echo "- âœ… Há»— trá»£ cháº¿ Ä‘á»™ tá»‘i/sÃ¡ng" >> release_description.md
        
        echo -e "\n## ğŸ“¥ Táº£i vá»" >> release_description.md
        echo "- **[â¬‡ï¸ Táº£i vá» file EXE](https://github.com/TranMC/Import-score/releases/download/v$VERSION/Student.Score.Import.v$VERSION.exe)** Ä‘á»ƒ cÃ i Ä‘áº·t trá»±c tiáº¿p" >> release_description.md

        echo -e "\n## ğŸ“ HÆ°á»›ng dáº«n sá»­ dá»¥ng" >> release_description.md
        echo "1. Táº£i vá» vÃ  cháº¡y file EXE" >> release_description.md
        echo "2. Chá»n file Excel chá»©a danh sÃ¡ch Ä‘iá»ƒm" >> release_description.md
        echo "3. Sá»­ dá»¥ng cÃ¡c chá»©c nÄƒng nháº­p Ä‘iá»ƒm, tÃ¬m kiáº¿m vÃ  xuáº¥t bÃ¡o cÃ¡o" >> release_description.md
        
        echo -e "\n## ğŸ”„ Cáº­p nháº­t" >> release_description.md
        echo "Pháº§n má»m sáº½ tá»± Ä‘á»™ng kiá»ƒm tra cáº­p nháº­t má»›i khi khá»Ÿi Ä‘á»™ng" >> release_description.md
        
        echo -e "\n---" >> release_description.md
        echo "ğŸ“… Build tá»± Ä‘á»™ng tá»« GitHub Actions ngÃ y $(date +%d/%m/%Y)" >> release_description.md
        
        cat release_description.md
      shell: bash
        
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        files: ./release_files/*.exe
        tag_name: v${{ env.VERSION }}
        name: ğŸ“Š Pháº§n má»m Quáº£n lÃ½ Äiá»ƒm Há»c Sinh v${{ env.VERSION }} ğŸš€
        body_path: ./release_description.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 